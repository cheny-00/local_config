# Fail2ban filter for Caddy reverse proxy to SeaweedFS S3
# Matches authentication failures and suspicious requests

[INCLUDES]
before = common.conf

[Definition]

# S3 认证失败（403 Forbidden - 签名错误/密钥错误）
# S3 未授权访问（401 Unauthorized）
# 异常请求（400 Bad Request - 可能是扫描）

# JSON 格式日志
failregex = ^.*"remote_ip":"<ADDR>".*"status":(?:403|401).*$
            ^.*"remote_ip":"<ADDR>".*"status":400.*"uri":".*(?:\.\.\/|etc\/passwd|\.env)".*$

# Common Log 格式 (Apache/Nginx style)
# 例如: 1.2.3.4 - - [01/Dec/2024:12:00:00 +0800] "GET /bucket/file HTTP/1.1" 403 1234
            ^<ADDR> - .* \[.*\] "(?:GET|PUT|POST|DELETE|HEAD) .* HTTP.*" (?:403|401) .*$
            ^<ADDR> - .* \[.*\] ".*(?:\.\.\/|etc\/passwd|\.env|\.git).*" 400 .*$

# Caddy 特定格式
# 例如: {"level":"info","ts":1234567890,"remote_ip":"1.2.3.4","status":403}
            ^.*remote_ip["\s:]+<ADDR>.*status["\s:]+(?:403|401).*$

ignoreregex =
